name: REST CI

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      ref:
        type: string
        required: false
        description: TileDB core reference to test against REST CI.
  push:

#    branches:
#      - dev
#      - release-*
#      - refs/tags/*

jobs:
  rest-ci:
    # TODO: runs-on: tiledb
    runs-on: ubuntu-latest

    steps:
      # For easy access to lookup dispatched CI job.
      - name: Print URL for REST CI actions
        run: echo https://github.com/TileDB-Inc/TileDB-Internal/actions

      # If this workflow fails on the remote repository, this CI job will also fail.
      - name: Workflow dispatch to REST CI
        id: trigger-step
        uses: aurelien-baudet/workflow-dispatch@v2
        env:
          TILEDB_REST_CI_TOKEN: ${{ secrets.TILEDB_REST_CI_PAT }}
          # TODO: TILEDB_REST_CI_TOKEN: ${{ secrets.GH_TOKEN }}
        # Skip if no PAT is set (e.g. for PRs from forks).
        if: env.TILEDB_REST_CI_TOKEN != null
        with:
          repo: TileDB-Inc/TileDB-Internal
          # Trigger workflow on TileDB-Internal at this ref.
          ref: "smr/sc-64563/test-tiledb-server"
          workflow: rest-ci.yml
          token: ${{ env.TILEDB_REST_CI_TOKEN }}
          # Pass TileDB core ref to test against REST.
          # github.head_ref will only be set for PRs, so fallback to github.ref_name if triggered via push event.
          inputs: '{ "tiledb_ref": "${{ github.event.inputs.ref || github.head_ref || github.ref_name }}"}'
          wait-for-completion-timeout: 90m
